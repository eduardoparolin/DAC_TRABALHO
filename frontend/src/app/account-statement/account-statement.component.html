<div class="statement-header">
  <div class="statement-actions">
    <button mat-stroked-button (click)="refresh()" [disabled]="service.loading()">Atualizar extrato</button>
  </div>

  @if (!service.loading() && service.statement()) {
    <div class="statement-summary">
      <div><strong>Conta:</strong> {{ service.statement()?.conta }}</div>
      <div><strong>Saldo atual:</strong> {{ balance | currency:'BRL' }}</div>
    </div>
  }
</div>

@if (service.loading()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

@if (!service.loading() && service.statement()) {
  <div class="date-range-container" [formGroup]="dateRangeForm">
    <mat-form-field appearance="outline">
      <mat-label>Data inicial</mat-label>
      <input matInput [matDatepicker]="startPicker" formControlName="startDate">
      <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Data final</mat-label>
      <input matInput [matDatepicker]="endPicker" formControlName="endDate">
      <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>
  </div>

  <table mat-table [dataSource]="dailyStatements()" multiTemplateDataRows class="mat-elevation-z8 daily-statement-table">
    <!-- Date Column -->
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Data</th>
      <td mat-cell *matCellDef="let element" class="date-cell">
        {{ element.dateString }}
        @if (element.transactions.length === 0) {
          <span class="no-transactions">(sem movimentações)</span>
        }
      </td>
    </ng-container>

    <!-- Daily Change Column -->
    <ng-container matColumnDef="dailyChange">
      <th mat-header-cell *matHeaderCellDef>Variação do dia</th>
      <td mat-cell *matCellDef="let element" [class.red-text]="element.dailyChange < 0" [class.blue-text]="element.dailyChange > 0">
        {{ element.dailyChange | currency:'BRL' }}
      </td>
    </ng-container>

    <!-- End Balance Column -->
    <ng-container matColumnDef="endBalance">
      <th mat-header-cell *matHeaderCellDef>Saldo final</th>
      <td mat-cell *matCellDef="let element">
        {{ element.endBalance | currency:'BRL' }}
      </td>
    </ng-container>

    <!-- Expand Icon Column -->
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element">
        @if (element.transactions.length > 0) {
          <button mat-icon-button (click)="toggleRow(element); $event.stopPropagation()">
            <mat-icon>{{ element.isExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
          </button>
        }
      </td>
    </ng-container>

    <!-- Expanded Detail Row -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length" class="expanded-detail-cell">
        @if (element.isExpanded && element.transactions.length > 0) {
          <div class="transaction-detail-container">
            <table class="transaction-detail-table">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Tipo</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody>
                @for (transaction of element.transactions; track transaction) {
                  <tr [ngClass]="getTransactionRowClass(transaction)">
                    <td>{{ transaction.data | date: 'HH:mm' }}</td>
                    <td>{{ transaction.tipo }}</td>
                    <td>{{ transaction.valor | currency:'BRL' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </td>
    </ng-container>

    <!-- Table Rows -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns"
      class="daily-row"
      [class.clickable]="row.transactions.length > 0"
      (click)="row.transactions.length > 0 && toggleRow(row)"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['expandedDetail']"
      class="detail-row"
    ></tr>
  </table>
} @else if (!service.loading()) {
  <p>Nenhuma movimentação encontrada.</p>
}
